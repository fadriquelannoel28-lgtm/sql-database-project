<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Events</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <nav>
        <a href="{{ url_for('home') }}" class="home">Home</a>
        <a href="{{ url_for('event') }}" class="event active">Events</a>
        <a href="{{ url_for('report') }}" class="report">Report</a>
        <a href="{{ url_for('dashboard') }}" class="dashboard">Dashboard</a>
        <a href="{{ url_for('community') }}" class="community">Community</a>
    </nav>

    <div style="text-align: right; margin: 10px 50px;">
        <form action="{{ url_for('refresh_events') }}" method="post">
            <button type="submit" class="refresh-btn">Refresh</button>
        </form>
    </div>

    <div class="index margin-event">
        {% if events %}
            {% for event in events %}
            <div class="event-card">

                {% if username == event['created_by'] or username == 'admin' %}
                <form action="{{ url_for('delete_event', event_id=event['id']) }}" method="post" style="display:inline;">
                    <button class="delete-btn" type="submit">Ã—</button>
                </form>
                {% endif %}

                <div class="event-main">
                    <img src="{{ event['image'] or '/static/uploads/default.jpg' }}" alt="Event Image" class="event-image">

                    <div class="event-actions">
                        {% if event['status'] == 'Pending' %}
                            {% if not event['joined'] %}
                                {% if event['participants'] < 50 %}
                                    <form action="{{ url_for('join_event', event_id=event['id']) }}" method="post" style="display:inline;">
                                        <button class="join-btn" type="submit">Join</button>
                                    </form>
                                {% else %}
                                    <button class="join-btn disabled" disabled>Full</button>
                                {% endif %}
                            {% else %}
                                <button class="join-btn joined" disabled>Joined</button>
                            {% endif %}

                            {% if event['joined'] %}
                            <form action="{{ url_for('leave_event', event_id=event['id']) }}" method="post" style="display:inline;">
                                <button class="leave-btn" type="submit">Leave</button>
                            </form>
                            {% endif %}

                        {% elif event['status'] == 'In Progress' %}
                            <form action="{{ url_for('clear_event', event_id=event['id']) }}" method="post" style="display:inline;">
                                <button class="clear-btn" type="submit">Area Cleared</button>
                            </form>
                        {% endif %}
                    </div>

                    
                    <div class="status-container">
                        <div class="status pending {% if event['status'] == 'Pending' %}active{% endif %}">Pending</div>
                        <div class="status in-progress {% if event['status'] == 'In Progress' %}active{% endif %}">In&nbsp;Progress</div>
                        <div class="status resolved {% if event['status'] == 'Resolved' %}active{% endif %}">Resolved</div>
                    </div>

                    {% if event['status'] == 'Resolved' %}
                    <div class="resolved-actions">
                        <p>Collected Trash: {{ event['collected_trash'] or 0 }} kg</p>

                        {% if username == event['created_by'] or username == 'admin' %}
                            {% if event.get('is_editing', False) %}
                            
                                <form action="{{ url_for('submit_trash', event_id=event['id']) }}" method="post" style="display:inline;">
                                    <input type="number" name="collected_trash" value="{{ event['collected_trash'] or 0 }}" min="0" step="0.1">
                                    <button type="submit" class="submit-btn">Submit</button>
                                </form>
                            {% else %}
                                
                                <form action="{{ url_for('edit_trash', event_id=event['id']) }}" method="post" style="display:inline;">
                                    <button type="submit" class="edit-btn">Edit</button>
                                </form>
                            {% endif %}
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <div class="event-details">
                    <p><strong>Location:</strong> {{ event['location'] }}</p>
                    <hr>
                    <p><strong>Date & Time:</strong> {{ event['datetime'] }}</p>
                    <hr>
                    <p><strong>Participants:</strong> {{ event['participants'] }} / {{ event['max_participants'] }}</p>
                    <hr>
                    <p><strong>Description:</strong> {{ event['description'] }}</p>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="text-align:center;">No events found yet.</p>
        {% endif %}
    </div>
</body>
</html>
